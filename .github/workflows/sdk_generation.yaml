name: Generate
permissions:
  checks: write
  contents: write
  pull-requests: write
  statuses: write
  id-token: write
"on":
  workflow_dispatch:
    inputs:
      force:
        description: Force generation of SDKs
        type: boolean
        default: false
      set_version:
        description: optionally set a specific SDK version
        type: string
  schedule:
    - cron: 0 0 * * *
  pull_request:
    types:
      - labeled
      - unlabeled
jobs:
  create-ga-branch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Find last GA release and create branch
        run: |
          # Fetch all tags
          git fetch --tags

          # Get all tags, filter out pre-releases (containing -), sort by semver, and get the latest
          LAST_GA_TAG=$(git tag -l | grep -v '-' | sort -V | tail -n 1)

          if [ -z "$LAST_GA_TAG" ]; then
            echo "No GA release tag found"
            exit 1
          fi

          echo "Last GA release: $LAST_GA_TAG"

          # Delete old ga-release branch if it exists
          git branch -D ga-release 2>/dev/null || true
          git push origin --delete ga-release 2>/dev/null || true

          # Create fresh ga-release branch from the GA tag
          git checkout -b ga-release "$LAST_GA_TAG"
          
          # Configure git identity
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "GitHub Actions Bot"
          
          # Touch workflow.lock to trigger a commit
          touch .speakeasy/workflow.lock
          git add .speakeasy/workflow.lock
          git commit -m "Update ga-release branch to $LAST_GA_TAG"
          
          git push origin ga-release

          echo "Created ga-release branch from $LAST_GA_TAG"

  generate:
    needs: create-ga-branch
    uses: subomi/sdk-generation-action/.github/workflows/workflow-executor.yaml@main
    with:
      force: ${{ github.event.inputs.force }}
      mode: pr
      feature_branch: ga-release
      set_version: ${{ github.event.inputs.set_version }}
    secrets:
      github_access_token: ${{ secrets.GITHUB_TOKEN }}
      speakeasy_api_key: ${{ secrets.SPEAKEASY_API_KEY }}
      slack_webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
